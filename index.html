<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Strumento immagini</title>
  <style>
    :root{--bg:#f7f8fb;--fg:#111;--muted:#666;--card:#fff}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--fg)}
    header{padding:16px 20px;background:#fff;border-bottom:1px solid #eee;font-weight:700}
    #wrap{max-width:900px;margin:20px auto;padding:0 16px}
    .tabs{display:flex;gap:8px;margin-bottom:16px}
    .tab{padding:10px 14px;border-radius:10px;border:1px solid #ddd;background:#fff;cursor:pointer}
    .tab.active{background:#111;color:#fff;border-color:#111}
    .card{background:var(--card);border:1px solid #eee;border-radius:14px;padding:16px}
    label{display:block;font-size:14px;color:#333;margin:8px 0 6px}
    textarea,input,select{width:100%;padding:12px;border:1px solid #ddd;border-radius:10px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row>*{flex:1 1 220px}
    button{padding:12px 16px;border:0;border-radius:12px;background:#111;color:#fff;cursor:pointer}
    .status{margin-top:10px;font-size:14px;color:#555}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;margin-top:16px}
    .img{width:100%;border-radius:12px}
    .help{font-size:12px;color:#666}
    .pill{display:inline-block;background:#f1f3f7;border:1px solid #e4e7ee;padding:6px 10px;border-radius:999px;font-size:12px;margin-right:6px;margin-bottom:6px;cursor:pointer}
    .pill.active{background:#111;color:#fff;border-color:#111}
  </style>
</head>
<body>
<header>Generatore immagini (semplice)</header>
<div id="wrap">

  <div class="tabs">
    <div class="tab active" data-tab="gen">Crea immagine</div>
    <div class="tab" data-tab="edit">Modifica immagine</div>
  </div>

  <!-- CREA -->
  <div id="panel-gen" class="card">
    <label>Stile (facoltativo)</label>
    <div id="preset-box">
      <span class="pill active" data-val="">Nessuno</span>
      <span class="pill" data-val="in stile tatuaggio old school, bianco e nero, linee nette">Old School B/N</span>
      <span class="pill" data-val="in stile neo-traditional, colori saturi, contorni marcati">Neo-Traditional</span>
      <span class="pill" data-val="fine-line, linee sottili, minimal">Fine-line</span>
      <span class="pill" data-val="acquerello, palette pastello, effetto carta">Acquerello</span>
    </div>

    <label>Descrivi l'immagine</label>
    <textarea id="gen-prompt" rows="3" placeholder="Es: bulldog francese che piange petali di rosa"></textarea>

    <div class="row">
      <div>
        <label>Dimensione</label>
        <select id="gen-size">
          <option>1024x1024</option>
          <option>1024x768</option>
          <option>768x1024</option>
          <option>512x512</option>
        </select>
      </div>
      <div>
        <label>Quante immagini</label>
        <select id="gen-n">
          <option>1</option><option>2</option><option>3</option><option>4</option>
        </select>
      </div>
    </div>

    <p><button id="btn-genera">Crea immagine</button></p>
    <div id="gen-status" class="status"></div>
    <div id="gen-out" class="grid"></div>
    <p class="help">Suggerimento: frasi semplici tipo “tatuaggio old school di una rosa con foglie, linee nette”.</p>
  </div>

  <!-- EDIT -->
  <div id="panel-edit" class="card" style="display:none">
    <label>Carica immagine (max ~6MB)</label>
    <input type="file" id="edit-file" accept="image/*"/>
    <label>Come la vuoi modificare?</label>
    <textarea id="edit-prompt" rows="3" placeholder="Es: rendila in stile tatuaggio old school in bianco e nero"></textarea>
    <div class="row">
      <div>
        <label>Dimensione risultato</label>
        <select id="edit-size">
          <option>1024x1024</option>
          <option>1024x768</option>
          <option>768x1024</option>
          <option>512x512</option>
        </select>
      </div>
      <div style="align-self:end">
        <button id="btn-edit">Modifica immagine</button>
      </div>
    </div>
    <div id="edit-status" class="status"></div>
    <div id="edit-out" class="grid"></div>
  </div>

</div>

<script>
const $ = (id)=>document.getElementById(id);

// Tabs
document.querySelectorAll('.tab').forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const tab=t.dataset.tab;
    document.getElementById('panel-gen').style.display = tab==='gen'?'block':'none';
    document.getElementById('panel-edit').style.display = tab==='edit'?'block':'none';
  };
});

// Preset stile
let presetVal = "";
document.querySelectorAll('#preset-box .pill').forEach(p=>{
  p.onclick=()=>{
    document.querySelectorAll('#preset-box .pill').forEach(x=>x.classList.remove('active'));
    p.classList.add('active');
    presetVal = p.dataset.val || "";
  };
});

// CREA
$('btn-genera').onclick = async ()=>{
  const promptBase = $('gen-prompt').value.trim();
  if(!promptBase){ $('gen-status').textContent='Scrivi una descrizione.'; return; }
  const prompt = presetVal ? `${promptBase}, ${presetVal}` : promptBase;
  const size = $('gen-size').value;
  const n = $('gen-n').value;

  $('gen-status').textContent='⏳ Creo...';
  $('gen-out').innerHTML='';
  try{
    const r = await fetch('/api/image-generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt,size,n})});
    const data = await r.json();
    if(!r.ok || data.error){ $('gen-status').textContent='Errore: '+(data.error||r.status); return; }
    $('gen-status').textContent='';
    data.images.forEach(b64=>{
      const a=document.createElement('a'); a.download='image.png'; a.href='data:image/png;base64,'+b64;
      const img=document.createElement('img'); img.src=a.href; img.className='img';
      a.appendChild(img); $('gen-out').appendChild(a);
    });
  }catch(e){ $('gen-status').textContent='Errore di rete.'; }
};

// EDIT
$('btn-edit').onclick = async ()=>{
  const f = $('edit-file').files[0];
  const prompt = $('edit-prompt').value.trim();
  const size = $('edit-size').value;
  if(!f){ $('edit-status').textContent='Seleziona un’immagine.'; return; }
  if(f.size>6*1024*1024){ $('edit-status').textContent='Immagine troppo grande (max ~6MB).'; return; }
  if(!prompt){ $('edit-status').textContent='Scrivi come vuoi modificarla.'; return; }

  $('edit-status').textContent='⏳ Modifico...';
  $('edit-out').innerHTML='';
  const reader=new FileReader();
  reader.onload=async ()=>{
    try{
      const b64=reader.result.split(',')[1];
      const r = await fetch('/api/image-edit',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt,image_b64:b64,size})});
      const data = await r.json();
      if(!r.ok || data.error){ $('edit-status').textContent='Errore: '+(data.error||r.status); return; }
      $('edit-status').textContent='';
      data.images.forEach(b64=>{
        const a=document.createElement('a'); a.download='image.png'; a.href='data:image/png;base64,'+b64;
        const img=document.createElement('img'); img.src=a.href; img.className='img';
        a.appendChild(img); $('edit-out').appendChild(a);
      });
    }catch(e){ $('edit-status').textContent='Errore di rete.'; }
  };
  reader.readAsDataURL(f);
};
</script>
</body>
</html>
